# Transaction Analyser - Production Docker Compose
# Usage:
#   Update services:  docker compose -f docker-compose.prod.yml pull && docker compose -f docker-compose.prod.yml up -d
#   View logs:        docker compose -f docker-compose.prod.yml logs -f
#   Stop:             docker compose -f docker-compose.prod.yml down

services:
  homefi-web:
    image: ghcr.io/samsonnegedu/transaction_analyser-web:latest
    container_name: transaction-analyser-web
    pull_policy: always
    restart: unless-stopped
    networks:
      - transaction-analyser-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  homefi-api:
    image: ghcr.io/samsonnegedu/transaction_analyser-api:latest
    container_name: transaction-analyser-api
    pull_policy: always
    restart: unless-stopped
    env_file: .env
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATA_DIR=/data
    volumes:
      - api-data:/data # Persistent storage for SQLite database
    networks:
      - transaction-analyser-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: transaction-analyser-cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - transaction-analyser-network
    depends_on:
      homefi-api:
        condition: service_healthy
      homefi-web:
        condition: service_healthy

volumes:
  api-data:
    name: transaction-analyser-api-data

networks:
  transaction-analyser-network:
    driver: bridge
