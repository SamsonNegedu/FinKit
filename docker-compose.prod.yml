# FinKit - Production Docker Compose
# Usage:
#   Update services:  docker compose -f docker-compose.prod.yml pull && docker compose -f docker-compose.prod.yml up -d
#   View logs:        docker compose -f docker-compose.prod.yml logs -f
#   Stop:             docker compose -f docker-compose.prod.yml down

services:
  finkit-web:
    image: ghcr.io/samsonnegedu/finkit-web:latest
    container_name: finkit-web
    pull_policy: always
    restart: unless-stopped
    networks:
      - finkit-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  finkit-api:
    image: ghcr.io/samsonnegedu/finkit-api:latest
    container_name: finkit-api
    pull_policy: always
    restart: unless-stopped
    env_file: .env
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATA_DIR=/data
    volumes:
      - api-data:/data # Persistent storage for SQLite database
    networks:
      - finkit-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: finkit-cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    networks:
      - finkit-network
    depends_on:
      finkit-api:
        condition: service_healthy
      finkit-web:
        condition: service_healthy

volumes:
  api-data:
    name: finkit-api-data

networks:
  finkit-network:
    driver: bridge
